---
    -   hosts: labora-UE-non3GPP
        become: yes
        remote_user: root
        vars:
            UE_NON3GPP_DIR_INSTALL: "/root/go/src/UE-non3GPP"
            UE_NON3GPPCONFIG_DIR: "/root/go/src/UE-non3GPP/config"
            HOME_DIR: "/root"
            PERMANENT_KEY_VALUE: "5122250214c33e723a5dd523fc145fc0"
            OPC_VALUE: "981d464c7c52eb6e5036234984ad0bcf"
            OP_VALUE: "c9e8763286b5b9ffbdf56e1297d0887b"
            SEQ_NUMBER: "16f3b3f70fcf"
            SUPI: "imsi-2089300007487"
            AUTH_MN_FIELD: "8000"
            IPSEC_INTERFACE: "ipsec0"
            GRE_TUN_INTERFACE: "gretun0"
            UE_NON3GPP_IP_ADDR: "127.0.0.1"
            MASCARA_REDE_DECIMAL: "19"
            GO_SRC_DIR : "/root/go/src"
            UE_NON3GPP_PORT_UDP_CONNECTION: "500"
            LABORA_UE_NON3GPP_GIT_REPO: "https://github.com/LABORA-INF-UFG/UE-non3GPP.git"
        tasks:
            - set_fact:
                UE_NON3GPP_IP_ADDR: "{{ ansible_default_ipv4.address }}"

            - name: Remove UE-non3GPP dir (if exists)
              shell:  sudo rm -rf {{ UE_NON3GPP_DIR_INSTALL }}
              ignore_errors: true

            - name  : Git Clone UE-non3GPP
              shell : git clone {{ LABORA_UE_NON3GPP_GIT_REPO }} {{ UE_NON3GPP_DIR_INSTALL  }}
              args:
                chdir: "{{ GO_SRC_DIR }}"

            - name: Remove UE-non3GPP config file
              shell: rm config.yaml
              args:
                chdir: "{{ UE_NON3GPPCONFIG_DIR }}"
              

            - name: Build UE-non3GPP config.yaml
              copy:
                dest: "{{ UE_NON3GPPCONFIG_DIR }}/config.yaml"
                content: |
                  ue:
                    authsubscription:
                      permanentkeyvalue: "{{ PERMANENT_KEY_VALUE }}"
                      opcvalue: "{{ OPC_VALUE }}"
                      opvalue: "{{ OP_VALUE }}"
                      sequencenumber: "{{ SEQ_NUMBER }}"
                    supi: "{{ SUPI }}"
                    ranuengapid: 1
                    amfuengapid: 1
                    authenticationmanagementfield : "{{ AUTH_MN_FIELD }}"
                    localpublicipaddr : "{{ UE_NON3GPP_IP_ADDR }}"
                    localpublicportudpconnection : "{{ UE_NON3GPP_PORT_UDP_CONNECTION }}"
                    linkgre:
                      name : "gretun0"
                      ipaddress: [60,60,0,1]
                      mask: [255,255,255,0]
                    ipsecinterfacename : "{{ IPSEC_INTERFACE }}" # IP address of IPSec virtual interface (IPsec tunnel enpoint to N3IWF)
                    ipsecinterfacemark: "5" # IPSec virtual interface mark (Any value except to 0, default value is 7 if not defined)
                    snssai: # Single Network Slice Selection Assistance Information
                      sst: 1 # Slice/Service Type (1 byte hex string, range: 0~F)
                      sd: "010203" # Slice Differentiator (3 bytes hex string, range: 000000~FFFFFF)
                    pdusessionid: 10
                    dnnstring: "internet"
                  
                  n3iwfinfo:
                    ikebindaddress: "{{ n3iwf_ike_ip_address }}" # IP address of Nwu interface (IKE) on N3IWF
                    ikebindport: "500"
                    ipsecifaceprotocol: "udp"
                  
                  logs:
                    level: 4

            - name  : Remove UE-non3GPP ipsec0 confg (if exists)
              shell : |
                sudo ip link del {{ IPSEC_INTERFACE }}
              ignore_errors: true

            - name  : Config UE-non3GPP ipsec0
              shell : |
                sudo ip link add {{ IPSEC_INTERFACE }} type vti local {{ UE_NON3GPP_IP_ADDR }} remote {{ n3iwf_ike_ip_address }} key 5
                sudo ip link set {{ IPSEC_INTERFACE }} up
